import{i as Ke,a9 as Ue,aa as Ee,x as H,ab as fe,j as e,v as j,t as R,r as g,ac as Xe,ad as U,q as D,G as Q,c as O,N as Pe,ae as he,af as Ye,ag as Je,ah as Ze,ai as es,aj as ss,ak as ts,al as ne,am as as,an as rs,M as Te,O as ns,Z as ls,_ as is,$ as cs,a0 as ye,a1 as os,ao as ge,ap as ds,aq as us,ar as ms,B as ie,as as xs,at as ce,au as Me,av as hs,aw as gs,ax as Oe,ay as re,S as ps,Q as fs,R as _e,az as pe,aA as ze,aB as ys,aC as js,aD as Ns,aE as A,aF as J,aG as bs,aH as Se,o as oe,s as de,l as ws,y as ue,C as me,a as vs,b as ks,d as xe,Y as Cs,aI as Ts}from"./index-DkVHath_.js";import{u as je,C as Ne,G as be,a as Ie,b as Ms,c as Ss,D as Ds,d as As,e as Es,P as Ps}from"./core.esm-CPaT8Axd.js";import{V as Os}from"./ViewLayout-ya6HA0TA.js";import{V as _s}from"./ViewStats-DttAbdqo.js";import{c as zs,a as F,i as Z}from"./formatters-D8DoMX06.js";import{g as we,a as Be,b as Fe,c as ve,d as Is,e as De}from"./styling-Ga5ccOhh.js";import{C as ee}from"./circle-check-big-Co1hWzCU.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bs=Ke("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);function le(s){return+Ue(s)<Date.now()}function Fs(s){return Ee(s,H(zs(s),1))}const qs=({task:s,onClick:t})=>{const{attributes:n,listeners:r,setNodeRef:i,transform:u,isDragging:x}=je({id:`task-${s.id}`,data:{type:"unscheduled-task",task:s}}),c={transform:Ne.Translate.toString(u)},a=s.subCategory?fe[s.subCategory]:null,h=we(s.category),p=Be(s.subCategory,"badge"),m=Fe(s.subCategory);return e.jsx("div",{ref:i,style:c,className:j("group p-2.5 rounded-lg border bg-card transition-all cursor-pointer",x&&"opacity-50 shadow-lg z-50","hover:shadow-md hover:border-primary/30"),onClick:t,...n,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:j("w-1.5 self-stretch rounded-full shrink-0",h)}),e.jsx("button",{...r,className:"mt-0.5 cursor-grab active:cursor-grabbing text-muted-foreground hover:text-foreground opacity-0 group-hover:opacity-100 transition-opacity",onClick:f=>f.stopPropagation(),children:e.jsx(be,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium line-clamp-2 leading-tight",children:s.name}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1.5 flex-wrap",children:[a&&e.jsx("span",{className:j("text-[10px] px-1.5 py-0.5 rounded-full font-medium",p),children:m}),e.jsxs("div",{className:"flex items-center gap-0.5 text-[10px] text-muted-foreground",children:[e.jsx(R,{className:"w-2.5 h-2.5"}),e.jsx("span",{children:F(s.estimatedTime)})]}),e.jsx("span",{className:"text-[10px]",children:ve(s.context)})]})]})]})})},Hs=(s,t=5)=>{if(!s.recurrence)return[];const n=[];let r=new Date(s.startsAt);const{frequency:i,interval:u,daysOfWeek:x,daysOfMonth:c}=s.recurrence,a=new Date;a.setHours(0,0,0,0),r<a&&(r=new Date(a));let h=0;const p=365;for(;n.length<t&&h<p;){h++;let m=!1;switch(i){case"daily":m=!0;break;case"weekly":x&&x.length>0?m=x.includes(r.getDay()):m=r.getDay()===s.startsAt.getDay();break;case"bi-weekly":m=Math.floor((r.getTime()-s.startsAt.getTime())/(7*24*60*60*1e3))%2===0&&r.getDay()===s.startsAt.getDay();break;case"monthly":c&&c.length>0?m=c.includes(r.getDate()):m=r.getDate()===s.startsAt.getDate();break;default:m=!0}switch(m&&r>=a&&n.push(new Date(r)),i){case"daily":r=H(r,u||1);break;case"weekly":case"bi-weekly":r=H(r,1);break;case"monthly":r=H(r,1);break;default:r=H(r,1)}}return n},Qs=({event:s,completedDates:t=[],maxOccurrences:n=5,className:r})=>{const i=g.useMemo(()=>Hs(s,n),[s,n]),u=c=>t.some(a=>Ee(a,c));if(!s.recurrence||i.length===0)return null;const x={daily:"Quotidien",weekly:"Hebdomadaire","bi-weekly":"Bi-mensuel",monthly:"Mensuel",yearly:"Annuel",custom:"Personnalis√©"};return e.jsxs("div",{className:j("space-y-3",r),children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Xe,{className:"w-4 h-4 text-system-info"}),e.jsx("span",{className:"font-medium",children:x[s.recurrence.frequency]||"R√©current"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-xs text-muted-foreground mb-2",children:["Prochaines ",n," occurrences:"]}),e.jsx("div",{className:"grid gap-1",children:i.map((c,a)=>{const h=u(c),p=a===0;return e.jsxs("div",{className:j("flex items-center gap-2 px-2 py-1.5 rounded text-xs",p&&"bg-primary/10 font-medium",h&&"bg-system-success/10"),children:[e.jsx(U,{className:j("w-3.5 h-3.5",p?"text-primary":"text-muted-foreground",h&&"text-system-success")}),e.jsx("span",{className:j(h&&"line-through text-muted-foreground"),children:D(c,"EEEE d MMMM yyyy",{locale:Q})}),h&&e.jsx(ee,{className:"w-3.5 h-3.5 text-system-success ml-auto"}),p&&!h&&e.jsx("span",{className:"ml-auto text-[10px] text-primary bg-primary/20 px-1.5 py-0.5 rounded",children:"Prochaine"})]},c.toISOString())})})]})]})},X={morning:{label:"Matin",icon:"üåÖ",startHour:6,endHour:12},afternoon:{label:"Apr√®s-midi",icon:"‚òÄÔ∏è",startHour:12,endHour:18},evening:{label:"Soir",icon:"üåô",startHour:18,endHour:22}},qe=({event:s,onComplete:t,onRemove:n,onClick:r,compact:i=!1})=>{var l,v;const{attributes:u,listeners:x,setNodeRef:c,transform:a,isDragging:h}=je({id:`event-${s.id}`,data:{type:"scheduled-event",event:s}}),p={transform:Ne.Translate.toString(a)},m=s.status==="completed";(l=s.description)==null||l.includes("project:"),(v=s.description)==null||v.includes("team:");const f=s.category,d=f?we(f):"bg-primary";return e.jsxs("div",{ref:c,style:p,className:j("group relative flex items-start gap-1.5 rounded border transition-all cursor-pointer",m?"bg-muted/50 border-muted":"bg-card border-border hover:border-primary/30",h&&"opacity-50 shadow-lg z-50",i?"p-1.5":"p-2"),onClick:r,...u,children:[e.jsx("div",{className:j("w-1.5 self-stretch rounded-full shrink-0",m?"bg-muted":d)}),e.jsx("button",{...x,className:j("cursor-grab active:cursor-grabbing text-muted-foreground/50 hover:text-muted-foreground shrink-0",i&&"hidden group-hover:block"),onClick:C=>C.stopPropagation(),children:e.jsx(be,{className:j(i?"w-3 h-3":"w-3.5 h-3.5")})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:j("flex items-start gap-1",i?"text-[10px]":"text-xs"),children:e.jsx("span",{className:j("font-medium leading-tight line-clamp-2",m&&"line-through text-muted-foreground"),children:s.title})}),e.jsxs("div",{className:j("flex items-center gap-1.5 text-muted-foreground mt-0.5 flex-wrap",i?"text-[9px]":"text-[10px]"),children:[s.timeBlock&&e.jsx("span",{className:"flex items-center gap-0.5",children:X[s.timeBlock].icon}),e.jsxs("span",{className:"flex items-center gap-0.5",children:[e.jsx(R,{className:"w-2.5 h-2.5"}),F(s.duration)]})]})]}),e.jsxs("div",{className:j("flex items-center gap-0.5 shrink-0",i&&"opacity-0 group-hover:opacity-100"),children:[e.jsx(O,{variant:"ghost",size:"icon",className:j("rounded-full",i?"h-5 w-5":"h-6 w-6",m&&"text-system-success"),onClick:C=>{C.stopPropagation(),t==null||t()},children:e.jsx(Pe,{className:j(i?"w-3 h-3":"w-3.5 h-3.5")})}),e.jsx(O,{variant:"ghost",size:"icon",className:j("rounded-full text-muted-foreground hover:text-destructive",i?"h-5 w-5":"h-6 w-6"),onClick:C=>{C.stopPropagation(),n==null||n()},children:e.jsx(he,{className:j(i?"w-3 h-3":"w-3.5 h-3.5")})})]})]})},Rs=[{value:0,label:"0h"},{value:60,label:"1h"},{value:120,label:"2h"},{value:180,label:"3h"},{value:240,label:"4h"},{value:300,label:"5h"},{value:360,label:"6h"},{value:480,label:"8h"},{value:600,label:"10h"}],$s=({value:s,onChange:t,className:n})=>e.jsxs(Ye,{value:String(s),onValueChange:r=>t(Number(r)),children:[e.jsxs(Je,{className:j("w-20 h-7 text-xs",n),children:[e.jsx(R,{className:"w-3 h-3 mr-1"}),e.jsx(Ze,{})]}),e.jsx(es,{children:Rs.map(r=>e.jsx(ss,{value:String(r.value),children:r.label},r.value))})]}),Ls=({events:s,onReschedule:t,onCancel:n,onRescheduleAll:r,className:i})=>{if(s.length===0)return null;const u=s.reduce((x,c)=>x+c.duration,0);return e.jsxs(ts,{variant:"destructive",className:j("border-system-warning/50 bg-system-warning/10",i),children:[e.jsx(ne,{className:"h-4 w-4 text-system-warning"}),e.jsxs(as,{className:"text-system-warning flex items-center gap-2",children:["T√¢ches en retard",e.jsxs("span",{className:"text-xs font-normal text-muted-foreground",children:["(",s.length," t√¢che",s.length>1?"s":""," ‚Ä¢ ",F(u),")"]})]}),e.jsxs(rs,{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"space-y-1 max-h-32 overflow-y-auto",children:[s.slice(0,5).map(x=>e.jsxs("div",{className:"flex items-center justify-between gap-2 p-1.5 rounded bg-background/50",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium truncate",children:x.title}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-0.5",children:[e.jsx(U,{className:"w-3 h-3"}),D(x.startsAt,"dd/MM",{locale:Q})]}),e.jsxs("span",{className:"flex items-center gap-0.5",children:[e.jsx(R,{className:"w-3 h-3"}),F(x.duration)]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(O,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>t==null?void 0:t(x.id),title:"Replanifier",children:e.jsx(Te,{className:"w-3.5 h-3.5"})}),e.jsx(O,{variant:"ghost",size:"icon",className:"h-6 w-6 text-destructive hover:text-destructive",onClick:()=>n==null?void 0:n(x.id),title:"Annuler",children:e.jsx(ns,{className:"w-3.5 h-3.5"})})]})]},x.id)),s.length>5&&e.jsxs("div",{className:"text-xs text-muted-foreground text-center py-1",children:["... et ",s.length-5," autre",s.length-5>1?"s":""]})]}),s.length>1&&r&&e.jsx("div",{className:"flex justify-end pt-1 border-t border-border/50",children:e.jsxs(O,{variant:"outline",size:"sm",className:"text-xs",onClick:r,children:[e.jsx(Te,{className:"w-3 h-3 mr-1"}),"Tout replanifier"]})})]})]})},Gs=({task:s,projectName:t,onClick:n})=>{const{attributes:r,listeners:i,setNodeRef:u,transform:x,isDragging:c}=je({id:`task-${s.id}`,data:{type:"unscheduled-task",task:s}}),a={transform:Ne.Translate.toString(x)},h=we(s.category),p=s.subCategory?fe[s.subCategory]:null,m=Be(s.subCategory,"badge"),f=Fe(s.subCategory);return e.jsxs("div",{ref:u,style:a,className:j("group flex items-start gap-2 p-2 rounded-md bg-card border transition-all cursor-pointer",c&&"opacity-50 shadow-lg z-50","hover:shadow-sm hover:bg-accent/50"),onClick:n,...r,children:[e.jsx("div",{className:j("w-1.5 self-stretch rounded-full shrink-0",h)}),e.jsx("button",{...i,className:"mt-0.5 cursor-grab active:cursor-grabbing text-muted-foreground/40 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",onClick:d=>d.stopPropagation(),children:e.jsx(be,{className:"w-3.5 h-3.5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium leading-tight line-clamp-2",children:s.name}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1 flex-wrap",children:[p&&e.jsx("span",{className:j("text-[10px] px-1.5 py-0.5 rounded-full font-medium",m),children:f}),e.jsxs("span",{className:"flex items-center gap-0.5 text-[10px] text-muted-foreground",children:[e.jsx(R,{className:"w-2.5 h-2.5"}),F(s.estimatedTime)]}),e.jsx("span",{className:"text-[10px]",children:ve(s.context)})]})]})]})},Vs=({deck:s,onTaskClick:t,defaultOpen:n=!0,projectNameMap:r})=>{const[i,u]=g.useState(n);return s.tasks.length===0?null:e.jsxs(ls,{open:i,onOpenChange:u,children:[e.jsx(is,{asChild:!0,children:e.jsxs("button",{className:j("w-full flex items-center gap-2 p-2.5 rounded-lg transition-colors","hover:bg-accent/50 text-left",s.color),children:[i?e.jsx(cs,{className:"w-4 h-4 text-muted-foreground shrink-0"}):e.jsx(ye,{className:"w-4 h-4 text-muted-foreground shrink-0"}),e.jsx("span",{className:"shrink-0",children:s.icon}),e.jsx("span",{className:"flex-1 font-medium text-sm truncate",children:s.name}),e.jsx("span",{className:"text-xs bg-muted/60 px-1.5 py-0.5 rounded-full text-muted-foreground",children:s.tasks.length}),e.jsxs("span",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(R,{className:"w-3 h-3"}),F(s.totalTime)]})]})}),e.jsx(os,{children:e.jsx("div",{className:"pl-4 pr-1 pb-2 space-y-1.5 mt-1",children:s.tasks.map(x=>e.jsx(Gs,{task:x,projectName:x.projectId?r==null?void 0:r.get(x.projectId):void 0,onClick:()=>t==null?void 0:t(x)},x.id))})})]})},Ws=({events:s,onEventClick:t,onUnschedule:n,onComplete:r,className:i})=>{const u=g.useMemo(()=>{const m=new Map;return[...s].sort((d,l)=>{const v=d.startsAt.getTime()-l.startsAt.getTime();if(v!==0)return v;const C={morning:0,afternoon:1,evening:2},S=d.timeBlock?C[d.timeBlock]:0,P=l.timeBlock?C[l.timeBlock]:0;return S-P}).forEach(d=>{const l=D(d.startsAt,"yyyy-MM-dd");m.has(l)||m.set(l,[]),m.get(l).push(d)}),m},[s]),x=s.filter(m=>m.status==="completed").length,c=s.reduce((m,f)=>m+f.duration,0),a=s.filter(m=>le(m.startsAt)&&m.status!=="completed"&&!Z(m.startsAt)).length,h=m=>{const f=new Date(m);return Z(f)?"Aujourd'hui":Fs(f)?"Demain":D(f,"EEEE d MMMM",{locale:Q})},p=m=>{const f=new Date(m);return le(f)&&!Z(f)};return s.length===0?e.jsxs("div",{className:j("text-center py-8 text-muted-foreground",i),children:[e.jsx(U,{className:"w-10 h-10 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"text-sm font-medium",children:"Aucune t√¢che planifi√©e"}),e.jsx("p",{className:"text-xs mt-1",children:"Glissez des t√¢ches pour les planifier"})]}):e.jsxs("div",{className:j("space-y-3",i),children:[e.jsxs("div",{className:"flex items-center justify-between px-1 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ee,{className:"w-3 h-3"}),x,"/",s.length]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(R,{className:"w-3 h-3"}),F(c)]})]}),a>0&&e.jsxs("span",{className:"flex items-center gap-1 text-destructive",children:[e.jsx(ne,{className:"w-3 h-3"}),a," en retard"]})]}),e.jsx(ge,{className:"max-h-[400px]",children:e.jsx("div",{className:"space-y-4 pr-2",children:Array.from(u.entries()).map(([m,f])=>{const d=p(m);return e.jsxs("div",{children:[e.jsxs("div",{className:j("flex items-center gap-2 mb-2 px-1",d&&"text-destructive"),children:[e.jsx(U,{className:"w-3 h-3"}),e.jsx("p",{className:"text-xs font-medium capitalize",children:h(m)}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",f.length,")"]}),d&&e.jsx(ne,{className:"w-3 h-3 ml-auto"})]}),e.jsx("div",{className:"space-y-1.5",children:f.map(l=>e.jsx(qe,{event:l,onClick:()=>t==null?void 0:t(l),onRemove:()=>n==null?void 0:n(l.id),onComplete:()=>r==null?void 0:r(l.id),compact:!0},l.id))})]},m)})})})]})},Ks=["Obligation","Quotidien","Envie","Autres"],Us=["Pro","Perso"],Xs=["Le plus important","Important","Peut attendre","Si j'ai le temps"],Ys=({filters:s,onFiltersChange:t,className:n})=>{const r=s.categories.length+s.contexts.length+s.priorities.length,i=a=>{const h=s.categories.includes(a)?s.categories.filter(p=>p!==a):[...s.categories,a];t({...s,categories:h})},u=a=>{const h=s.contexts.includes(a)?s.contexts.filter(p=>p!==a):[...s.contexts,a];t({...s,contexts:h})},x=a=>{const h=s.priorities.includes(a)?s.priorities.filter(p=>p!==a):[...s.priorities,a];t({...s,priorities:h})},c=()=>{t({categories:[],contexts:[],priorities:[]})};return e.jsxs("div",{className:j("flex items-center gap-1",n),children:[e.jsxs(ds,{children:[e.jsx(us,{asChild:!0,children:e.jsxs(O,{variant:r>0?"secondary":"ghost",size:"sm",className:"h-7 px-2 text-xs",children:[e.jsx(ms,{className:"w-3 h-3 mr-1"}),"Filtres",r>0&&e.jsx(ie,{variant:"default",className:"ml-1 h-4 px-1 text-[10px]",children:r})]})}),e.jsx(xs,{className:"w-72 p-3",align:"start",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Filtres"}),r>0&&e.jsxs(O,{variant:"ghost",size:"sm",className:"h-6 text-xs text-muted-foreground",onClick:c,children:[e.jsx(he,{className:"w-3 h-3 mr-1"}),"Effacer"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ce,{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(Bs,{className:"w-3 h-3"}),"Priorit√©"]}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:Xs.map(a=>{var m;const h=s.priorities.includes(a),p=fe[a];return e.jsxs("button",{className:j("flex items-center gap-1.5 px-2 py-1 rounded text-xs transition-colors",h?"bg-primary/10 text-primary border border-primary/30":"bg-muted/50 text-muted-foreground hover:bg-muted"),onClick:()=>x(a),children:[e.jsx("span",{className:j("w-2 h-2 rounded-full",((m=p==null?void 0:p.color)==null?void 0:m.split(" ")[0])||"bg-muted")}),e.jsx("span",{className:"truncate",children:a})]},a)})})]}),e.jsx(Me,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{className:"text-xs text-muted-foreground",children:"Cat√©gorie"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:Ks.map(a=>{const h=s.categories.includes(a);return e.jsx(O,{variant:h?"secondary":"outline",size:"sm",className:j("h-6 text-xs px-2",h&&Is(a,"badge")),onClick:()=>i(a),children:a},a)})})]}),e.jsx(Me,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{className:"text-xs text-muted-foreground",children:"Contexte"}),e.jsx("div",{className:"flex gap-2",children:Us.map(a=>{const h=s.contexts.includes(a);return e.jsxs(O,{variant:h?"secondary":"outline",size:"sm",className:"h-6 text-xs px-2",onClick:()=>u(a),children:[e.jsx("span",{className:"mr-1",children:ve(a)}),a]},a)})})]})]})})]}),r>0&&e.jsxs("div",{className:"flex items-center gap-1 flex-wrap",children:[s.priorities.slice(0,2).map(a=>e.jsxs(ie,{variant:"secondary",className:"h-5 text-[10px] px-1.5 cursor-pointer hover:bg-destructive/10",onClick:()=>x(a),children:[a,e.jsx(he,{className:"w-2.5 h-2.5 ml-0.5"})]},a)),s.priorities.length>2&&e.jsxs(ie,{variant:"outline",className:"h-5 text-[10px] px-1.5",children:["+",s.priorities.length-2]})]})]})},Js=({tasks:s,scheduledEvents:t=[],projects:n=[],onTaskClick:r,onEventClick:i,onUnscheduleEvent:u,onCompleteEvent:x,className:c})=>{const[a,h]=g.useState(""),[p,m]=g.useState(!1),[f,d]=g.useState("unscheduled"),[l,v]=g.useState({categories:[],contexts:[],priorities:[]}),C=g.useMemo(()=>{const M=new Map;return n.forEach(E=>M.set(E.id,E.name)),M},[n]),S=g.useMemo(()=>{let M=[...s];if(a){const E=a.toLowerCase();M=M.filter(W=>W.name.toLowerCase().includes(E))}return l.categories.length>0&&(M=M.filter(E=>l.categories.includes(E.category))),l.contexts.length>0&&(M=M.filter(E=>l.contexts.includes(E.context))),l.priorities.length>0&&(M=M.filter(E=>E.subCategory&&l.priorities.includes(E.subCategory))),M},[s,a,l]),P=g.useMemo(()=>{const M=[],E=[],W=new Map;S.forEach(N=>{!!N.teamId?E.push(N):N.projectId?(W.has(N.projectId)||W.set(N.projectId,[]),W.get(N.projectId).push(N)):M.push(N)});const o=(N,k)=>De(k.subCategory)-De(N.subCategory),y=[];return M.length>0&&y.push({id:"free-tasks",name:"T√¢ches libres",icon:e.jsx(hs,{className:"w-4 h-4"}),color:"bg-muted/30",tasks:M.sort(o),totalTime:M.reduce((N,k)=>N+k.estimatedTime,0)}),W.forEach((N,k)=>{const b=n.find(T=>T.id===k);y.push({id:`project-${k}`,name:(b==null?void 0:b.name)||"Projet",icon:e.jsx("span",{className:"text-sm",children:(b==null?void 0:b.icon)||"üìÅ"}),color:"bg-project/10",tasks:N.sort(o),totalTime:N.reduce((T,I)=>T+I.estimatedTime,0)})}),E.length>0&&y.push({id:"team-tasks",name:"√âquipe",icon:e.jsx(gs,{className:"w-4 h-4"}),color:"bg-primary/10",tasks:E.sort(o),totalTime:E.reduce((N,k)=>N+k.estimatedTime,0)}),y},[S,n]),K=S.length,$=S.reduce((M,E)=>M+E.estimatedTime,0),Y=l.categories.length>0||l.contexts.length>0||l.priorities.length>0;return e.jsxs("div",{className:j("flex flex-col bg-card border rounded-xl overflow-hidden transition-all duration-200",p?"w-12":"w-80",c),children:[e.jsxs("div",{className:j("flex items-center gap-2 p-3 border-b bg-muted/20",p&&"flex-col py-4 px-2"),children:[e.jsx(O,{variant:"ghost",size:"icon",className:"h-7 w-7 shrink-0",onClick:()=>m(!p),children:p?e.jsx(ye,{className:"w-4 h-4"}):e.jsx(Oe,{className:"w-4 h-4"})}),!p&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex gap-0.5 bg-muted/40 rounded-md p-0.5 flex-1",children:[e.jsxs(O,{variant:f==="unscheduled"?"secondary":"ghost",size:"sm",className:"h-6 text-xs flex-1",onClick:()=>d("unscheduled"),children:[e.jsx(re,{className:"w-3 h-3 mr-1"}),"√Ä faire (",s.length,")"]}),e.jsxs(O,{variant:f==="scheduled"?"secondary":"ghost",size:"sm",className:"h-6 text-xs flex-1",onClick:()=>d("scheduled"),children:[e.jsx(U,{className:"w-3 h-3 mr-1"}),"Planifi√©es (",t.length,")"]})]})})]}),p?e.jsx("div",{className:"flex-1 flex flex-col items-center justify-center py-4 gap-3",children:f==="unscheduled"?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-sm font-bold",children:s.length}),e.jsx("span",{className:"text-[10px] text-muted-foreground [writing-mode:vertical-lr]",children:"√† faire"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-sm font-bold",children:t.length}),e.jsx("span",{className:"text-[10px] text-muted-foreground [writing-mode:vertical-lr]",children:"planifi√©es"})]})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-2 space-y-2 border-b",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ps,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-muted-foreground"}),e.jsx(fs,{placeholder:"Rechercher...",value:a,onChange:M=>h(M.target.value),className:"h-8 pl-8 text-sm"})]}),f==="unscheduled"&&e.jsx(Ys,{filters:l,onFiltersChange:v})]}),f==="unscheduled"?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"flex-1",children:e.jsx("div",{className:"p-2 space-y-1",children:P.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(re,{className:"w-10 h-10 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"text-sm font-medium",children:"Aucune t√¢che"}),e.jsx("p",{className:"text-xs mt-1",children:a||Y?"Essayez de modifier vos filtres":"Toutes vos t√¢ches sont planifi√©es !"})]}):P.map(M=>e.jsx(Vs,{deck:M,onTaskClick:r,defaultOpen:M.tasks.length<=5,projectNameMap:C},M.id))})}),e.jsx("div",{className:"p-3 border-t bg-muted/10",children:e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"text-muted-foreground",children:[K," t√¢che",K!==1?"s":"",Y&&e.jsx("span",{className:"text-primary ml-1",children:"(filtr√©es)"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 font-medium",children:[e.jsx(R,{className:"w-3.5 h-3.5 text-muted-foreground"}),e.jsx("span",{children:F($)})]})]})})]}):e.jsx(ge,{className:"flex-1",children:e.jsx("div",{className:"p-2",children:e.jsx(Ws,{events:t,onEventClick:i,onUnschedule:u,onComplete:x})})})]})]})},Zs=({date:s,events:t,onCompleteEvent:n,onRemoveEvent:r,onEventClick:i,disabled:u=!1})=>{const x=_e.useMemo(()=>{const c={morning:[],afternoon:[],evening:[]};return t.forEach(a=>{let h="morning";if(a.timeBlock)h=a.timeBlock;else{const p=a.startsAt.getHours();p>=X.evening.startHour?h="evening":p>=X.afternoon.startHour&&(h="afternoon")}c[h].push(a)}),Object.values(c).forEach(a=>{a.sort((h,p)=>h.startsAt.getTime()-p.startsAt.getTime())}),c},[t]);return e.jsx("div",{className:"grid grid-cols-3 gap-4",children:["morning","afternoon","evening"].map(c=>e.jsx(et,{block:c,date:s,events:x[c],onCompleteEvent:n,onRemoveEvent:r,onEventClick:i,disabled:u},c))})},et=({block:s,date:t,events:n,onCompleteEvent:r,onRemoveEvent:i,onEventClick:u,disabled:x})=>{const c=X[s],a=`block-${t.toISOString().split("T")[0]}-${s}`,{isOver:h,setNodeRef:p}=Ie({id:a,data:{type:"time-block",block:s,date:t.toISOString()},disabled:x}),m=n.reduce((d,l)=>d+l.duration,0),f=n.filter(d=>d.status==="completed").length;return e.jsxs("div",{ref:p,className:j("flex flex-col rounded-xl border-2 border-dashed transition-all min-h-[200px]",h&&!x&&"border-primary bg-primary/5",x?"bg-muted/20 border-muted":"border-border hover:border-muted-foreground/40"),children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-muted/30 rounded-t-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:c.icon}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-sm",children:c.label}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:[c.startHour,"h - ",c.endHour,"h"]})]})]}),n.length>0&&e.jsxs("span",{className:"text-xs text-muted-foreground bg-muted px-2 py-0.5 rounded-full",children:[f,"/",n.length," ‚Ä¢ ",Math.round(m/60),"h"]})]}),e.jsx("div",{className:"flex-1 p-3 space-y-2",children:n.length===0?e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsx("p",{className:"text-sm text-muted-foreground/50 text-center",children:x?"‚Äî":"Glissez une t√¢che ici"})}):n.map(d=>e.jsx(qe,{event:d,onComplete:()=>r==null?void 0:r(d.id),onRemove:()=>i==null?void 0:i(d.id),onClick:()=>u==null?void 0:u(d)},d.id))})]})},st=({date:s,events:t,quota:n,onEventClick:r,onCompleteEvent:i})=>{const u=Z(s),x=le(s)&&!u,c=`day-${D(s,"yyyy-MM-dd")}`,{isOver:a,setNodeRef:h}=Ie({id:c,data:{type:"day-column",date:s.toISOString()},disabled:x}),p=t.reduce((l,v)=>l+v.duration,0),m=t.filter(l=>l.status==="completed").length,f=n>0?Math.min(p/n*100,100):0,d=p>n;return e.jsxs("div",{ref:h,className:j("flex flex-col rounded-xl border transition-all min-h-[300px]",u&&"ring-2 ring-primary/40 border-primary/40",x&&"opacity-60",a&&!x&&"border-primary bg-primary/5"),children:[e.jsxs("div",{className:j("px-3 py-2.5 border-b",u?"bg-primary/10":"bg-muted/30"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:j("text-sm font-semibold capitalize",u&&"text-primary"),children:D(s,"EEE",{locale:Q})}),e.jsx("div",{className:"text-xl font-bold",children:D(s,"d",{locale:Q})})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:[m,"/",t.length]}),e.jsx("div",{className:j("text-xs font-medium",d?"text-system-warning":"text-muted-foreground"),children:F(p)})]})]}),e.jsx(pe,{value:f,className:j("h-1 mt-2",d&&"[&>div]:bg-system-warning")})]}),e.jsx("div",{className:"flex-1 p-2 space-y-1 overflow-hidden",children:t.length===0?e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsx("p",{className:"text-xs text-muted-foreground/50",children:x?"‚Äî":"Glissez ici"})}):t.sort((l,v)=>l.startsAt.getTime()-v.startsAt.getTime()).map(l=>e.jsx(tt,{event:l,onClick:()=>r==null?void 0:r(l),onComplete:()=>i==null?void 0:i(l.id)},l.id))})]})},tt=({event:s,onClick:t,onComplete:n})=>{const r=s.status==="completed";return e.jsxs("div",{className:j("group flex items-center gap-1.5 p-1.5 rounded-md border cursor-pointer transition-all",r?"bg-muted/50 border-muted":"bg-card border-border hover:border-primary/30 hover:shadow-sm"),onClick:t,children:[e.jsx("button",{className:j("shrink-0 w-4 h-4 rounded-full border flex items-center justify-center transition-colors",r?"bg-system-success border-system-success text-white":"border-muted-foreground/30 hover:border-primary hover:bg-primary/10"),onClick:i=>{i.stopPropagation(),n==null||n()},children:r&&e.jsx(Pe,{className:"w-2.5 h-2.5"})}),e.jsx("span",{className:j("flex-1 text-xs truncate",r&&"line-through text-muted-foreground"),children:s.title}),e.jsxs("span",{className:"text-[10px] text-muted-foreground flex items-center gap-0.5 shrink-0",children:[e.jsx(R,{className:"w-2.5 h-2.5"}),F(s.duration)]})]})},at=({date:s,events:t,quota:n,onQuotaChange:r,onCompleteEvent:i,onRemoveEvent:u,onEventClick:x})=>{const c=Z(s),a=t.reduce((v,C)=>v+C.duration,0),h=t.filter(v=>v.status==="completed").length,p=t.filter(v=>v.status==="completed").reduce((v,C)=>v+C.duration,0),m=n>0?Math.min(a/n*100,100):0,f=a>0?p/a*100:0,d=a>n,l=h===t.length&&t.length>0;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:j("p-4 rounded-xl border-2",c?"border-primary/30 bg-primary/5":"border-border bg-card"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:j("text-2xl font-bold capitalize",c&&"text-primary"),children:D(s,"EEEE d MMMM",{locale:Q})}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-0.5",children:[t.length," t√¢che",t.length!==1?"s":""," planifi√©e",t.length!==1?"s":""]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l&&e.jsxs("div",{className:"flex items-center gap-1.5 text-system-success bg-system-success/10 px-3 py-1.5 rounded-full",children:[e.jsx(ee,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Compl√©t√©"})]}),d&&!l&&e.jsxs("div",{className:"flex items-center gap-1.5 text-system-warning bg-system-warning/10 px-3 py-1.5 rounded-full",children:[e.jsx(ne,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Surcharg√©"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between text-xs mb-1.5",children:[e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1",children:[e.jsx(R,{className:"w-3.5 h-3.5"}),"Planifi√©"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:j("font-medium",d?"text-system-warning":"text-foreground"),children:[F(a)," /"]}),r?e.jsx($s,{value:n,onChange:r}):e.jsx("span",{className:"font-medium",children:F(n)})]})]}),e.jsx(pe,{value:m,className:j("h-2",d&&"[&>div]:bg-system-warning")})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between text-xs mb-1.5",children:[e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1",children:[e.jsx(ee,{className:"w-3.5 h-3.5"}),"Compl√©t√©"]}),e.jsxs("span",{className:"font-medium",children:[h," / ",t.length]})]}),e.jsx(pe,{value:f,className:"h-2 [&>div]:bg-system-success"})]})]})]}),e.jsx(Zs,{date:s,events:t,onCompleteEvent:i,onRemoveEvent:u,onEventClick:x})]})},rt=({startDate:s,eventsByDay:t,quotaByDay:n,defaultQuota:r=240,onEventClick:i,onCompleteEvent:u})=>{const x=_e.useMemo(()=>Array.from({length:7},(a,h)=>H(s,h)),[s]),c=D(s,"w");return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between px-2",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Semaine ",c]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[D(s,"d MMM",{locale:Q})," - ",D(H(s,6),"d MMM yyyy",{locale:Q})]})]}),e.jsx("div",{className:"grid grid-cols-7 gap-2",children:x.map(a=>{const h=D(a,"yyyy-MM-dd"),p=t.get(h)||[],m=(n==null?void 0:n.get(h))??r;return e.jsx(st,{date:a,events:p,quota:m,onEventClick:i,onCompleteEvent:u},h)})})]})},Ae=s=>X[s].startHour,nt=s=>{const{user:t}=ze(),{tasks:n,updateTask:r}=ys(),{events:i,loadEvents:u,checkConflicts:x}=js(s),{syncTaskEventWithSchedule:c,deleteEntityEvent:a,updateEventStatus:h}=Ns(),p=g.useRef(!1),m=g.useMemo(()=>{const o=new Set(i.filter(y=>y.entityType==="task").map(y=>y.entityId));return n.filter(y=>!y.isCompleted&&!o.has(y.id)&&y.level===0)},[n,i]),f=g.useMemo(()=>i.filter(o=>o.status!=="cancelled"),[i]),d=g.useMemo(()=>i.filter(o=>le(o.startsAt)&&!Z(o.startsAt)&&o.status!=="completed"&&o.status!=="cancelled"&&o.entityType==="task"),[i]),l=g.useCallback(async()=>{if(!(!t||d.length===0)){A.debug("Cleaning up overdue events",{count:d.length});for(const o of d)try{await a("task",o.entityId),A.debug("Auto-unscheduled overdue task",{taskId:o.entityId,taskTitle:o.title,originalDate:D(o.startsAt,"yyyy-MM-dd")})}catch(y){A.warn("Failed to cleanup overdue event",{eventId:o.id,error:y.message})}await u()}},[t,d,a,u]);g.useEffect(()=>{d.length>0&&!p.current&&(p.current=!0,l())},[d.length,l]);const v=g.useCallback(async({taskId:o,date:y,hour:N,minute:k,duration:b})=>{if(!t)return!1;const T=n.find(_=>_.id===o);if(!T)return A.warn("Task not found for scheduling",{taskId:o}),!1;if(T.isCompleted)return A.warn("Cannot schedule completed task",{taskId:o}),!1;const I=i.find(_=>_.entityType==="task"&&_.entityId===o&&_.status!=="cancelled");I&&A.debug("Task already scheduled, will reschedule",{taskId:o,existingEventId:I.id});try{const _=`${String(N).padStart(2,"0")}:${String(k).padStart(2,"0")}`,L=b?{...T,duration:b,estimatedTime:b}:T,ae=await c(L,{date:y,time:_,isRecurring:!1});return ae&&(await u(),A.debug("Task scheduled",{taskId:o,date:y,time:_,duration:L.duration||L.estimatedTime})),ae}catch(_){return A.error("Failed to schedule task",{error:_.message,taskId:o}),!1}},[t,n,i,c,u]),C=g.useCallback(async({taskId:o,date:y,block:N,duration:k})=>{if(!t)return!1;const b=n.find(T=>T.id===o);if(!b)return A.warn("Task not found for scheduling",{taskId:o}),!1;if(b.isCompleted)return A.warn("Cannot schedule completed task",{taskId:o}),!1;try{const T=Ae(N),I=`${String(T).padStart(2,"0")}:00`,_=k?{...b,duration:k,estimatedTime:k}:b,L=await c(_,{date:y,time:I,isRecurring:!1});return L&&(await J.from("time_events").update({time_block:N}).eq("entity_type","task").eq("entity_id",o).eq("user_id",t.id),await u(),A.debug("Task scheduled to block",{taskId:o,date:D(y,"yyyy-MM-dd"),block:N})),L}catch(T){return A.error("Failed to schedule task to block",{error:T.message,taskId:o}),!1}},[t,n,c,u]),S=g.useCallback(async(o,y,N,k)=>{if(!t)return!1;const b=i.find(T=>T.id===o);if(!b)return A.warn("Event not found for rescheduling",{eventId:o}),!1;if(b.entityType==="task"){const T=n.find(I=>I.id===b.entityId);if(T)return await v({taskId:T.id,date:y,hour:N,minute:k,duration:b.duration})}return!1},[t,i,n,v]),P=g.useCallback(async(o,y,N)=>{if(!t)return!1;const k=i.find(b=>b.id===o);if(!k)return A.warn("Event not found for rescheduling",{eventId:o}),!1;try{const b=Ae(N),T=D(y,"yyyy-MM-dd"),I=new Date(`${T}T${String(b).padStart(2,"0")}:00:00`),_=new Date(I.getTime()+k.duration*60*1e3),{error:L}=await J.from("time_events").update({starts_at:I.toISOString(),ends_at:_.toISOString(),time_block:N,updated_at:new Date().toISOString()}).eq("id",o).eq("user_id",t.id);if(L)throw L;return await u(),A.debug("Event rescheduled to block",{eventId:o,date:T,block:N}),!0}catch(b){return A.error("Failed to reschedule event to block",{error:b.message,eventId:o}),!1}},[t,i,u]),K=g.useCallback(async(o,y)=>{if(!t)return!1;const N=i.find(k=>k.id===o);if(!N)return A.warn("Event not found for resizing",{eventId:o}),!1;try{const k=new Date(N.startsAt.getTime()+y*60*1e3),{error:b}=await J.from("time_events").update({duration:y,ends_at:k.toISOString(),updated_at:new Date().toISOString()}).eq("id",o).eq("user_id",t.id);if(b)throw b;return await u(),A.debug("Event resized",{eventId:o,newDuration:y}),!0}catch(k){return A.error("Failed to resize event",{error:k.message,eventId:o}),!1}},[t,i,u]),$=g.useCallback(async o=>{if(!t)return!1;const y=i.find(N=>N.id===o);if(!y)return!1;try{const N=await a(y.entityType,y.entityId);return N&&(await u(),A.debug("Event unscheduled",{eventId:o})),N}catch(N){return A.error("Failed to unschedule event",{error:N.message,eventId:o}),!1}},[t,i,a,u]),Y=g.useCallback(async o=>{const y=i.find(b=>b.id===o);if(!y)return!1;const N=y.status==="completed"?"scheduled":"completed",k=await h(y.entityType,y.entityId,N);if(k){if(y.entityType==="task"){const b=n.find(T=>T.id===y.entityId);b&&await r(b.id,{isCompleted:N==="completed"})}await u()}return k},[i,n,h,r,u]),M=g.useCallback((o,y,N,k)=>{const b=new Date(o);b.setHours(y,N,0,0);const T=new Date(b.getTime()+k*60*1e3),I={id:"test",entityType:"task",entityId:"test",userId:(t==null?void 0:t.id)||"",startsAt:b,endsAt:T,duration:k,isAllDay:!1,title:"Test",status:"scheduled",createdAt:new Date,updatedAt:new Date};return x(I).length>0},[t,x]),E=g.useCallback(o=>n.find(y=>y.id===o),[n]),W=g.useCallback(o=>i.find(y=>y.id===o),[i]);return{unscheduledTasks:m,scheduledEvents:f,overdueEvents:d,scheduleTask:v,rescheduleEvent:S,resizeEvent:K,scheduleTaskToBlock:C,rescheduleEventToBlock:P,unscheduleEvent:$,completeEvent:Y,hasConflict:M,getTaskById:E,getEventById:W,reload:u}},lt=()=>{const{user:s}=ze(),{preferences:t}=bs(),[n,r]=g.useState(new Map),[i,u]=g.useState(!1),x=t.timelineDefaultQuota||240,c=g.useCallback(async(f,d)=>{if(s){u(!0);try{const{data:l,error:v}=await J.from("day_planning_config").select("*").eq("user_id",s.id).gte("date",D(f,"yyyy-MM-dd")).lte("date",D(d,"yyyy-MM-dd"));if(v)throw v;const C=new Map;(l||[]).forEach(S=>{const P=S.date;C.set(P,{id:S.id,userId:S.user_id,date:new Date(S.date),quotaMinutes:S.quota_minutes,createdAt:new Date(S.created_at),updatedAt:new Date(S.updated_at)})}),r(C)}catch(l){A.error("Failed to load day planning configs",{error:l.message})}finally{u(!1)}}},[s]),a=g.useCallback(f=>{const d=D(f,"yyyy-MM-dd"),l=n.get(d);return(l==null?void 0:l.quotaMinutes)??x},[n]),h=g.useCallback(async(f,d)=>{if(!s)return!1;const l=D(f,"yyyy-MM-dd"),v=n.get(l);try{if(v){const{error:C}=await J.from("day_planning_config").update({quota_minutes:d}).eq("id",v.id);if(C)throw C}else{const{data:C,error:S}=await J.from("day_planning_config").insert({user_id:s.id,date:l,quota_minutes:d}).select().single();if(S)throw S;if(C){const P=C;r(K=>{const $=new Map(K);return $.set(l,{id:P.id,userId:P.user_id,date:new Date(P.date),quotaMinutes:P.quota_minutes,createdAt:new Date(P.created_at),updatedAt:new Date(P.updated_at)}),$})}}return v&&r(C=>{const S=new Map(C);return S.set(l,{...v,quotaMinutes:d}),S}),A.debug("Quota updated",{date:l,minutes:d}),!0}catch(C){return A.error("Failed to set quota",{error:C.message,date:l}),!1}},[s,n]),p=g.useCallback(f=>{const d=[];for(let l=0;l<7;l++){const v=H(f,l);d.push(a(v))}return d},[a]),m=g.useCallback(f=>f.reduce((d,l)=>d+a(l),0),[a]);return{loading:i,getQuotaForDate:a,setQuotaForDate:h,getWeeklyQuotas:p,getTotalQuota:m,loadConfigs:c,defaultQuota:x}},ht=({className:s})=>{const[t,n]=g.useState(new Date),[r,i]=g.useState("day"),[u,x]=g.useState(null),[c,a]=g.useState(null),[h,p]=g.useState(!1),m=g.useMemo(()=>{if(r==="day")return{start:oe(t),end:Se(t)};const w=de(t,{weekStartsOn:1});return{start:oe(w),end:Se(H(w,6))}},[t,r]),f=g.useMemo(()=>{if(r==="day")return[oe(t)];const w=de(t,{weekStartsOn:1});return Array.from({length:7},(q,B)=>H(w,B))},[t,r]),{unscheduledTasks:d,scheduledEvents:l,overdueEvents:v,scheduleTaskToBlock:C,rescheduleEventToBlock:S,unscheduleEvent:P,completeEvent:K}=nt(m),{getQuotaForDate:$,setQuotaForDate:Y,loadConfigs:M}=lt(),{projects:E}=ws();g.useEffect(()=>{M(m.start,m.end)},[m,M]);const W=Ms(Ss(Ps,{activationConstraint:{distance:8}})),o=g.useCallback(()=>{n(w=>H(w,r==="day"?-1:-7))},[r]),y=g.useCallback(()=>{n(w=>H(w,r==="day"?1:7))},[r]),N=g.useCallback(()=>{n(new Date)},[]),k=g.useCallback(w=>{const{active:q}=w,B=q.data.current;(B==null?void 0:B.type)==="unscheduled-task"?x(B.task):(B==null?void 0:B.type)==="scheduled-event"&&x(B.event)},[]),b=g.useCallback(async w=>{const{active:q,over:B}=w;if(x(null),!B)return;const z=q.data.current,G=B.data.current;if((G==null?void 0:G.type)==="time-block"){const se=G.block,te=new Date(G.date);if((z==null?void 0:z.type)==="unscheduled-task"){const V=z.task;await C({taskId:V.id,date:te,block:se,duration:V.duration||V.estimatedTime||30})}else if((z==null?void 0:z.type)==="scheduled-event"){const V=z.event;await S(V.id,te,se)}}if((G==null?void 0:G.type)==="day-column"){const se=new Date(G.date),te="morning";if((z==null?void 0:z.type)==="unscheduled-task"){const V=z.task;await C({taskId:V.id,date:se,block:te,duration:V.duration||V.estimatedTime||30})}else if((z==null?void 0:z.type)==="scheduled-event"){const V=z.event;await S(V.id,se,te)}}},[C,S]),T=g.useCallback(async w=>{await K(w)},[K]),I=g.useCallback(async w=>{await P(w)},[P]),_=g.useCallback(w=>{a(w)},[]),L=g.useCallback(()=>{a(null),p(!1)},[]),ae=g.useCallback(async w=>{await S(w,new Date,"morning")},[S]),He=g.useCallback(async w=>{await P(w)},[P]),ke=g.useMemo(()=>{const w=new Map;return f.forEach(q=>{const B=D(q,"yyyy-MM-dd"),z=l.filter(G=>D(G.startsAt,"yyyy-MM-dd")===B);w.set(B,z)}),w},[l,f]),Qe=g.useMemo(()=>{const w=new Map;return f.forEach(q=>{w.set(D(q,"yyyy-MM-dd"),$(q))}),w},[f,$]),Re=l.reduce((w,q)=>w+q.duration,0),$e=l.filter(w=>w.status==="completed").length,Le=d.reduce((w,q)=>w+q.estimatedTime,0),Ge=f.reduce((w,q)=>w+$(q),0),Ve=[{id:"scheduled",label:"Planifi√©",value:`${F(Re)} / ${F(Ge)}`,icon:e.jsx(R,{className:"w-4 h-4"})},{id:"completed",label:"Termin√©s",value:`${$e}/${l.length}`,icon:e.jsx(ee,{className:"w-4 h-4"})},{id:"backlog",label:"√Ä planifier",value:`${d.length} (${F(Le)})`,icon:e.jsx(re,{className:"w-4 h-4"})}],Ce=c!=null&&c.recurrence?c:null,We=de(t,{weekStartsOn:1});return e.jsxs(Os,{header:{title:"Planification",subtitle:"Organisez votre journ√©e",icon:e.jsx(ue,{className:"w-5 h-5"})},state:"success",className:s,children:[e.jsxs(Ds,{sensors:W,collisionDetection:As,onDragStart:k,onDragEnd:b,children:[e.jsxs("div",{className:"space-y-4 pb-20 md:pb-6",children:[e.jsx(_s,{stats:Ve,columns:3}),v.length>0&&e.jsx(Ls,{events:v,onReschedule:ae,onCancel:He}),e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(O,{variant:r==="day"?"default":"outline",size:"sm",onClick:()=>i("day"),children:[e.jsx(U,{className:"w-4 h-4 mr-1"}),"Jour"]}),e.jsxs(O,{variant:r==="week"?"default":"outline",size:"sm",onClick:()=>i("week"),children:[e.jsx(ue,{className:"w-4 h-4 mr-1"}),"Semaine"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{variant:"outline",size:"icon",onClick:o,children:e.jsx(Oe,{className:"w-4 h-4"})}),e.jsx(O,{variant:"ghost",size:"sm",onClick:N,className:"min-w-[180px]",children:D(t,r==="day"?"EEEE d MMMM":"'Sem.' w - MMMM yyyy",{locale:Q})}),e.jsx(O,{variant:"outline",size:"icon",onClick:y,children:e.jsx(ye,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(Js,{tasks:d,scheduledEvents:l,projects:E,onTaskClick:w=>{console.log("Task clicked",w)},onEventClick:_,onUnscheduleEvent:I,onCompleteEvent:T}),e.jsxs("div",{className:"flex-1 min-w-0",children:[r==="day"&&e.jsx(at,{date:t,events:ke.get(D(t,"yyyy-MM-dd"))||[],quota:$(t),onQuotaChange:w=>Y(t,w),onCompleteEvent:T,onRemoveEvent:I,onEventClick:_}),r==="week"&&e.jsx(rt,{startDate:We,eventsByDay:ke,quotaByDay:Qe,defaultQuota:240,onEventClick:_,onCompleteEvent:T})]})]}),c&&e.jsxs(me,{className:"animate-in slide-in-from-bottom-2",children:[e.jsx(vs,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ks,{className:"text-base",children:c.title}),e.jsx(O,{variant:"ghost",size:"sm",onClick:()=>a(null),children:"‚úï"})]})}),e.jsxs(xe,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(R,{className:"w-4 h-4"}),F(c.duration)]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(U,{className:"w-4 h-4"}),D(c.startsAt,"PPP",{locale:Q})]}),c.timeBlock&&e.jsxs("span",{className:"text-xs",children:[X[c.timeBlock].icon," ",X[c.timeBlock].label]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground border-t pt-2 space-y-1",children:[e.jsxs("p",{children:["Cr√©√© le ",D(c.createdAt,"PPP",{locale:Q})]}),c.completedAt&&e.jsxs("p",{className:"text-system-success",children:["Termin√© le ",D(c.completedAt,"PPP",{locale:Q})]})]}),Ce&&e.jsx("div",{className:"border-t pt-3",children:e.jsx(Qs,{event:Ce,maxOccurrences:5})}),e.jsxs("div",{className:"flex gap-2 pt-2 border-t",children:[e.jsxs(O,{size:"sm",variant:c.status==="completed"?"outline":"default",onClick:()=>T(c.id),children:[e.jsx(ee,{className:"w-4 h-4 mr-1"}),c.status==="completed"?"Rouvrir":"Terminer"]}),e.jsx(O,{size:"sm",variant:"outline",onClick:()=>I(c.id),children:"D√©-planifier"})]})]})]}),d.length>0&&l.length===0&&e.jsx(me,{className:"border-dashed",children:e.jsx(xe,{className:"flex items-center justify-center py-8 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ue,{className:"w-10 h-10 mx-auto mb-3 opacity-40"}),e.jsx("p",{className:"text-sm font-medium",children:"Glissez vos t√¢ches dans les blocs horaires"}),e.jsx("p",{className:"text-xs mt-1",children:"Matin ‚Ä¢ Apr√®s-midi ‚Ä¢ Soir"})]})})}),d.length===0&&l.length===0&&e.jsx(me,{className:"border-dashed",children:e.jsx(xe,{className:"flex items-center justify-center py-8 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Cs,{className:"w-10 h-10 mx-auto mb-3 opacity-40"}),e.jsx("p",{className:"text-sm font-medium",children:"Aucune t√¢che √† planifier"}),e.jsx("p",{className:"text-xs mt-1",children:"Ajoutez des t√¢ches depuis la vue T√¢ches"})]})})})]}),e.jsx(Es,{children:u&&"name"in u?e.jsx("div",{className:"opacity-90 w-64",children:e.jsx(qs,{task:u})}):u&&"title"in u?e.jsx("div",{className:"opacity-90 w-48 h-12 bg-primary/20 rounded-md border-l-4 border-primary px-2 py-1",children:e.jsx("span",{className:"text-xs font-medium",children:u.title})}):null})]}),h&&e.jsx(Ts,{isOpen:h,onClose:L})]})};export{ht as default};
